!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("moment"),require("socket.io-client")):"function"==typeof define&&define.amd?define("@babili.io/angular",["exports","@angular/core","@angular/common/http","rxjs","rxjs/operators","moment","socket.io-client"],t):t((e.babili=e.babili||{},e.babili.io=e.babili.io||{},e.babili.io.angular={}),e.ng.core,e.ng.common.http,null,e.Rx.Observable.prototype,null,null)}(this,function(e,t,n,d,i,o,r){"use strict";var s=function(){function e(){}return e.prototype.init=function(e,t,n){this.url={apiUrl:e,socketUrl:t,aliveIntervalInMs:n}},Object.defineProperty(e.prototype,"apiUrl",{get:function(){return this.url?this.url.apiUrl:undefined},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"socketUrl",{get:function(){return this.url?this.url.socketUrl:undefined},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"aliveIntervalInMs",{get:function(){return this.url?this.url.aliveIntervalInMs:3e4},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Injectable}],e}(),a=function(){function e(){}return e.prototype.isApiTokenSet=function(){return this.apiToken!==undefined&&null!==this.apiToken&&""!==this.apiToken},e.prototype.clear=function(){this.apiToken=undefined},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[]},e}(),u=function(e){this.error=e},p=function(){function e(e,t){this.configuration=e,this.tokenConfiguration=t}return e.prototype.intercept=function(e,t){return this.shouldAddHeaderTo(e)?t.handle(this.addHeaderTo(e,this.tokenConfiguration.apiToken)).pipe(i.catchError(function(e){return e instanceof n.HttpErrorResponse&&401===e.status?d.throwError(new u(e)):d.throwError(e)})):t.handle(e)},e.prototype.addHeaderTo=function(e,t){return e.clone({headers:e.headers.set("Authorization","Bearer "+t)})},e.prototype.shouldAddHeaderTo=function(e){return e.url.startsWith(this.configuration.apiUrl)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:s},{type:a}]},e}(),c=function(){function t(e,t){this.id=e,this.status=t}return t.build=function(e){return e?new t(e.id,e.attributes?e.attributes.status:undefined):undefined},t.map=function(e){return e?e.map(t.build):undefined},t}(),f=o,h=function(){function n(e,t,n,o,r,i){this.id=e,this.content=t,this.contentType=n,this.createdAt=o,this.sender=r,this.roomId=i}return n.build=function(e){var t=e.attributes;return new n(e.id,t.content,t.contentType,f(t.createdAt).toDate(),e.relationships.sender?c.build(e.relationships.sender.data):undefined,e.relationships.room.data.id)},n.map=function(e){return e?e.map(n.build):undefined},n.prototype.hasSenderId=function(e){return this.sender&&this.sender.id===e},n}(),l=function(){function e(e,t){this.http=e,this.configuration=t}return e.prototype.create=function(e,t){return this.http.post(this.messageUrl(e.id),{data:{type:"message",attributes:t}}).pipe(i.map(function(e){return h.build(e.data)}))},e.prototype.findAll=function(e,t){return this.http.get(this.messageUrl(e.id),{params:t}).pipe(i.map(function(e){return h.map(e.data)}))},e.prototype["delete"]=function(e,t){return this.http["delete"](this.messageUrl(e.id)+"/"+t.id).pipe(i.map(function(e){return t}))},e.prototype.messageUrl=function(e){return this.roomUrl+"/"+e+"/messages"},Object.defineProperty(e.prototype,"roomUrl",{get:function(){return this.configuration.apiUrl+"/user/rooms"},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:n.HttpClient},{type:s}]},e}(),m=o,y=function(){function u(e,t,n,o,r,i,s,a,u,p){this.id=e,this.users=i,this.senders=s,this.messages=a,this.initiator=u,this.roomRepository=p,this.internalOpen=new d.BehaviorSubject(o),this.internalLastActivityAt=new d.BehaviorSubject(n),this.internalName=new d.BehaviorSubject(t),this.internalUnreadMessageCount=new d.BehaviorSubject(r),this.internalImageUrl=new d.BehaviorSubject(undefined)}return u.build=function(e,t,n){var o=e.attributes,r=e.relationships&&e.relationships.users?c.map(e.relationships.users.data):[],i=e.relationships&&e.relationships.senders?c.map(e.relationships.senders.data):[],s=e.relationships&&e.relationships.messages?h.map(e.relationships.messages.data):[],a=e.relationships&&e.relationships.initiator?c.build(e.relationships.initiator.data):undefined;return new u(e.id,o.name,o.lastActivityAt?m(o.lastActivityAt).utc().toDate():undefined,o.open,o.unreadMessageCount,r,i,s,a,t)},u.map=function(e,t,n){return e?e.map(function(e){return u.build(e,t,n)}):undefined},Object.defineProperty(u.prototype,"unreadMessageCount",{get:function(){return this.internalUnreadMessageCount.value},set:function(e){this.internalUnreadMessageCount.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"observableUnreadMessageCount",{get:function(){return this.internalUnreadMessageCount},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"name",{get:function(){return this.internalName.value},set:function(e){this.internalName.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"observableName",{get:function(){return this.internalName},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"open",{get:function(){return this.internalOpen.value},set:function(e){this.internalOpen.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"observableOpen",{get:function(){return this.internalOpen},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"lastActivityAt",{get:function(){return this.internalLastActivityAt.value},set:function(e){this.internalLastActivityAt.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"observableLastActivityAt",{get:function(){return this.internalLastActivityAt},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"imageUrl",{get:function(){return this.internalImageUrl.value},set:function(e){this.internalImageUrl.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"observableImageUrl",{get:function(){return this.internalImageUrl},enumerable:!0,configurable:!0}),u.prototype.openMembership=function(){return this.roomRepository.updateMembership(this,!0)},u.prototype.closeMembership=function(){return this.roomRepository.updateMembership(this,!1)},u.prototype.markAllMessagesAsRead=function(){return this.roomRepository.markAllReceivedMessagesAsRead(this)},u.prototype.addMessage=function(e){this.messages.push(e),this.lastActivityAt=e.createdAt},u.prototype.notifyNewMessage=function(e){this.newMessageNotifier&&this.newMessageNotifier.apply(e)},u.prototype.hasUser=function(t){return this.users&&this.users.some(function(e){return e.id===t})},u.prototype.fetchMoreMessage=function(){var t=this,e={firstSeenMessageId:0<this.messages.length?this.messages[0].id:undefined};return this.roomRepository.findMessages(this,e).pipe(i.map(function(e){return t.messages.unshift.apply(t.messages,e),e}))},u.prototype.findMessageWithId=function(t){return this.messages?this.messages.find(function(e){return e.id===t}):undefined},u.prototype.update=function(){return this.roomRepository.update(this)},u.prototype.sendMessage=function(e){var t=this;return this.roomRepository.createMessage(this,e).pipe(i.map(function(e){return t.addMessage(e),e}))},u.prototype.removeMessage=function(t){var e=this.messages?this.messages.findIndex(function(e){return e.id===t.id}):-1;return-1<e&&this.messages.splice(e,1),t},u.prototype["delete"]=function(e){var t=this;return this.roomRepository.deleteMessage(this,e).pipe(i.map(function(e){return t.removeMessage(e)}))},u.prototype.replaceUsersWith=function(e){return this.users.splice(0,this.users.length),Array.prototype.push.apply(this.users,e.users),this},u.prototype.addUser=function(e){this.hasUser(e.id)||this.users.push(e)},u}(),g=function(){function e(e,t,n){this.http=e,this.messageRepository=t,this.configuration=n}return e.prototype.find=function(e){var t=this;return this.http.get(this.roomUrl+"/"+e).pipe(i.map(function(e){return y.build(e.data,t,t.messageRepository)}))},e.prototype.findAll=function(e){var t=this;return this.http.get(this.roomUrl,{params:e}).pipe(i.map(function(e){return y.map(e.data,t,t.messageRepository)}))},e.prototype.findOpenedRooms=function(){return this.findAll({onlyOpened:"true"})},e.prototype.findClosedRooms=function(){return this.findAll({onlyClosed:"true"})},e.prototype.findRoomsAfter=function(e){return this.findAll({firstSeenRoomId:e})},e.prototype.findRoomsByIds=function(e){return this.findAll({"roomIds[]":e})},e.prototype.updateMembership=function(t,e){return this.http.put(this.roomUrl+"/"+t.id+"/membership",{data:{type:"membership",attributes:{open:e}}}).pipe(i.map(function(e){return t.open=e.data.attributes.open,t}))},e.prototype.markAllReceivedMessagesAsRead=function(t){if(0<t.unreadMessageCount){var e=0<t.messages.length?t.messages[t.messages.length-1].id:undefined;return this.http.put(this.roomUrl+"/"+t.id+"/membership/unread-messages",{data:{lastReadMessageId:e}}).pipe(i.map(function(e){return t.unreadMessageCount=0,e.meta.count}))}return d.of(0)},e.prototype.create=function(e,t,n){var o=this;return this.http.post(this.roomUrl+"?noDuplicate="+n,{data:{type:"room",attributes:{name:e},relationships:{users:{data:t.map(function(e){return{type:"user",id:e}})}}}},{params:{noDuplicate:""+n}}).pipe(i.map(function(e){return y.build(e.data,o,o.messageRepository)}))},e.prototype.update=function(t){return this.http.put(this.roomUrl+"/"+t.id,{data:{type:"room",attributes:{name:t.name}}}).pipe(i.map(function(e){return t.name=e.data.attributes.name,t}))},e.prototype.addUser=function(n,e){return this.http.post(this.roomUrl+"/"+n.id+"/memberships",{data:{type:"membership",relationships:{user:{data:{type:"user",id:e}}}}}).pipe(i.map(function(e){var t=c.build(e.data.relationships.user.data);return n.addUser(t),n}))},e.prototype.deleteMessage=function(e,t){return this.messageRepository["delete"](e,t)},e.prototype.findMessages=function(e,t){return this.messageRepository.findAll(e,t)},e.prototype.createMessage=function(e,t){return this.messageRepository.create(e,t)},Object.defineProperty(e.prototype,"roomUrl",{get:function(){return this.configuration.apiUrl+"/user/rooms"},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:n.HttpClient},{type:l},{type:s}]},e}(),b=o,R=function(){function r(e,t,n,o,r,i){this.id=e,this.openedRooms=t,this.rooms=n,this.roomRepository=i,this.internalUnreadMessageCount=new d.BehaviorSubject(o||0),this.internalRoomCount=new d.BehaviorSubject(r||0)}return r.build=function(e,t){var n=e.data&&e.data.meta?e.data.meta.unreadMessageCount:0,o=e.data&&e.data.meta?e.data.meta.roomCount:0;return new r(e.data.id,[],[],n,o,t)},Object.defineProperty(r.prototype,"unreadMessageCount",{get:function(){return this.internalUnreadMessageCount.value},set:function(e){this.internalUnreadMessageCount.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"observableUnreadMessageCount",{get:function(){return this.internalUnreadMessageCount},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"roomCount",{get:function(){return this.internalRoomCount.value},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"observableRoomCount",{get:function(){return this.internalRoomCount},enumerable:!0,configurable:!0}),r.prototype.fetchOpenedRooms=function(){var t=this;return this.roomRepository.findOpenedRooms().pipe(i.map(function(e){return t.addRooms(e),e}))},r.prototype.fetchClosedRooms=function(){var t=this;return this.roomRepository.findClosedRooms().pipe(i.map(function(e){return t.addRooms(e),e}))},r.prototype.fetchMoreRooms=function(){var t=this;return this.firstSeenRoom?this.roomRepository.findRoomsAfter(this.firstSeenRoom.id).pipe(i.map(function(e){return t.addRooms(e),e})):d.of([])},r.prototype.fetchRoomsById=function(e){var t=this;return this.roomRepository.findRoomsByIds(e).pipe(i.map(function(e){return t.addRooms(e),e}))},r.prototype.fetchRoomById=function(e){var t=this;return this.roomRepository.find(e).pipe(i.map(function(e){return t.addRoom(e),e}))},r.prototype.findOrFetchRoomById=function(e){var t=this.findRoomById(e);return e?d.of(t):this.fetchRoomById(e)},r.prototype.handleNewMessage=function(t){var n=this;this.findOrFetchRoomById(t.roomId).subscribe(function(e){e&&(e.addMessage(t),e.notifyNewMessage(t),t.hasSenderId(n.id)||(n.unreadMessageCount=n.unreadMessageCount+1,e.open||(e.unreadMessageCount=e.unreadMessageCount+1)))})},r.prototype.addRoom=function(t){if(!this.hasRoom(t)){this.firstSeenRoom&&!b(this.firstSeenRoom.lastActivityAt).isAfter(t.lastActivityAt)||(this.firstSeenRoom=t);var e=this.rooms?this.rooms.findIndex(function(e){return e.id===t.id}):-1;-1<e?this.rooms[e]=t:this.rooms.push(t)}},r.prototype.findRoomById=function(t){return this.rooms?this.rooms.find(function(e){return t===e.id}):undefined},r.prototype.openRoom=function(e){var t=this;return this.hasRoomOpened(e)?d.of(e):e.openMembership().pipe(i.flatMap(function(e){return t.addToOpenedRoom(e),t.markAllReceivedMessagesAsRead(e)}))},r.prototype.closeRoom=function(e){var t=this;return this.hasRoomOpened(e)?e.closeMembership().pipe(i.map(function(e){return t.removeFromOpenedRoom(e),e})):d.of(e)},r.prototype.closeRooms=function(e){var t=this;return d.of(e).pipe(i.map(function(e){return e.forEach(function(e){return t.closeRoom(e)}),e}))},r.prototype.openRoomAndCloseOthers=function(t){var n=this,e=this.openedRooms.filter(function(e){return e.id!==t.id});return this.closeRooms(e).pipe(i.flatMap(function(e){return n.openRoom(t)}))},r.prototype.hasOpenedRooms=function(){return 0<this.openedRooms.length},r.prototype.createRoom=function(e,t,n){var o=this;return this.roomRepository.create(e,t,n).pipe(i.map(function(e){return o.addRoom(e),e}))},r.prototype.buildRoom=function(e){var t=e.map(function(e){return new c(e,"")}),n=undefined,o=this.toUser();return new y(n,undefined,undefined,!0,0,t,[],[],o,this.roomRepository)},r.prototype.sendMessage=function(e,t,n){return e.sendMessage({content:t,contentType:n,deviceSessionId:this.deviceSessionId})},r.prototype.isSentByMe=function(e){return e&&e.hasSenderId(this.id)},r.prototype.deleteMessage=function(e){if(e){var t=this.findRoomById(e.roomId);return t?t["delete"](e):d.of(undefined)}return d.of(undefined)},r.prototype.addUserTo=function(e,t){return this.roomRepository.addUser(e,t)},r.prototype.addRooms=function(e){var t=this;e.forEach(function(e){t.addRoom(e),e.open&&!t.hasRoomOpened(e)&&t.openedRooms.push(e)})},r.prototype.hasRoom=function(e){return this.findRoom(e)!==undefined},r.prototype.hasRoomOpened=function(e){return this.findRoomOpened(e)!==undefined},r.prototype.findRoom=function(e){return this.findRoomById(e.id)},r.prototype.findRoomOpened=function(t){return this.openedRooms?this.openedRooms.find(function(e){return t.id===e.id}):undefined},r.prototype.addToOpenedRoom=function(e){this.hasRoomOpened(e)||this.openedRooms.push(e)},r.prototype.removeFromOpenedRoom=function(t){if(this.hasRoomOpened(t)){var e=this.openedRooms?this.openedRooms.findIndex(function(e){return e.id===t.id}):undefined;this.openedRooms.splice(e,1)}},r.prototype.markAllReceivedMessagesAsRead=function(t){var n=this;return t.markAllMessagesAsRead().pipe(i.map(function(e){return n.unreadMessageCount=Math.max(n.unreadMessageCount-e,0),t}))},r.prototype.toUser=function(){return new c(this.id,"")},r}(),v=function(){function e(e,t,n){this.http=e,this.roomRepository=t,this.configuration=n}return e.prototype.findMe=function(){var t=this;return this.http.get(this.userUrl).pipe(i.map(function(e){return R.build(e,t.roomRepository)}))},e.prototype.updateAliveness=function(e){return this.http.put(this.aliveUrl,{data:{type:"alive"}}).pipe(i.catchError(function(){return d.empty()}),i.map(function(){return null}))},Object.defineProperty(e.prototype,"userUrl",{get:function(){return this.configuration.apiUrl+"/user"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"aliveUrl",{get:function(){return this.userUrl+"/alive"},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:n.HttpClient},{type:g},{type:s}]},e}(),M=function(){function e(e){this.configuration=e}return e.prototype.connect=function(e){return this.socket=r.connect(this.configuration.socketUrl,{forceNew:!0,query:"token="+e}),this.socket},e.prototype.socketExists=function(){return this.socket!==undefined},e.prototype.disconnect=function(){this.socketExists()&&(this.socket.close(),this.socket=undefined)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:s}]},e}(),A=function(){function e(e,t,n,o){this.meRepository=e,this.socketClient=t,this.configuration=n,this.tokenConfiguration=o,this.alive=!1}return e.prototype.setup=function(e){this.tokenConfiguration.isApiTokenSet()||(this.tokenConfiguration.apiToken=e)},e.prototype.me=function(){var t=this;return this.hasCachedMe()||(this.cachedMe=this.meRepository.findMe().pipe(i.map(function(e){return t.scheduleAliveness(e)}),i.publishReplay(1),i.refCount(),i.share())),this.cachedMe.pipe(i.map(function(e){return t.connectSocket(e)}))},e.prototype.clear=function(){this.tokenConfiguration.clear(),this.cachedMe=undefined,this.alive=!1},e.prototype.scheduleAliveness=function(e){var t=this;return this.alive=!0,d.timer(0,this.configuration.aliveIntervalInMs).pipe(i.takeWhile(function(){return t.alive})).subscribe(function(){return t.meRepository.updateAliveness(e)}),e},e.prototype.hasCachedMe=function(){return this.cachedMe!==undefined},e.prototype.connectSocket=function(t){var n=this;if(!this.socketClient.socketExists()){var e=this.socketClient.connect(this.tokenConfiguration.apiToken);e.on("new message",function(e){return n.receiveNewMessage(e)}),e.on("connected",function(e){return t.deviceSessionId=e.deviceSessionId})}return t},e.prototype.receiveNewMessage=function(e){var t=h.build(e.data);this.me().subscribe(function(e){return e.handleNewMessage(t)})},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:v},{type:M},{type:s},{type:a}]},e}(),U=o,C=function(){function e(){}return e.prototype.transform=function(e,t){return e!==undefined&&null!==e?e.sort(function(e,t){var n=e.lastActivityAt,o=t.lastActivityAt;return U(n).isBefore(o)?1:U(o).isBefore(n)?-1:0}):e},e.decorators=[{type:t.Pipe,args:[{name:"sortRooms"}]}],e}(),I=function(){function e(){}return e.forRoot=function(){return{ngModule:e,providers:[s,C,a,M,{provide:n.HTTP_INTERCEPTORS,useClass:p,multi:!0},l,g,v,A]}},e.decorators=[{type:t.NgModule,args:[{imports:[n.HttpClientModule],declarations:[C],exports:[C]}]}],e}();e.HttpAuthenticationInterceptor=p,e.NotAuthorizedError=u,e.BabiliModule=I,e.TokenConfiguration=a,e.MeRepository=v,e.MeService=A,e.Me=R,e.MessageRepository=l,e.Message=h,e.SortRoomPipe=C,e.RoomRepository=g,e.Room=y,e.BootstrapSocket=M,e.User=c,e.BabiliConfiguration=s,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=babili.io-angular.umd.min.js.map